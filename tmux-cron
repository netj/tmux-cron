#!/usr/bin/env uv run --script
# /// script
# dependencies = [
#   "croniter",
#   "pyyaml",
#   "tmuxp",
# ]
# ///

import os
import sys
import subprocess
import shutil
import tempfile
from datetime import datetime
from pathlib import Path

# Configuration
BASE_DIR = Path.home() / ".tmux-cron"
CRONTAB_FILE = BASE_DIR / "crontab"
YAML_FILE = BASE_DIR / "session.yaml"
SESSION_NAME = "tmux-cron"
RUNNER_PATH = os.path.abspath(__file__)

BASE_DIR.mkdir(parents=True, exist_ok=True)

def sh(cmd: str, env_vars: dict = None, **kwargs):
    """Executes a command with a custom environment for variable resolution."""
    current_env = os.environ.copy()
    if env_vars:
        current_env.update(env_vars)
    return subprocess.run(["bash", "-c", cmd], env=current_env, **kwargs)

def print_help():
    print(f"""
tmux-cron: A crontab-to-tmuxp replacement for modern macOS permissions.

Usage:
  tmux-cron                - Sync, launch, and attach (Default)
  tmux-cron -e, --edit     - Edit the tmux-cron crontab
  tmux-cron -l, --list     - List current tmux-cron crontab
  tmux-cron -a, --attach   - Attach to the existing session
  tmux-cron -h, --help     - Show this help message

  Internal:
  tmux-cron --run          - [Used by tmux panes] The cron-runner logic
    """)

def run_editor():
    if not CRONTAB_FILE.exists():
        CRONTAB_FILE.write_text("# Min Hour Dom Mon Dow Command\n# */5 * * * * echo 'hello world'\n")
    
    with tempfile.NamedTemporaryFile(suffix=".tmp", delete=False) as tmp:
        shutil.copyfile(CRONTAB_FILE, tmp.name)
        # Use $EDITOR from environment, fallback to nano
        sh('${EDITOR:-nano} "$TARGET"', env_vars={"TARGET": tmp.name})
        
        try:
            with open(tmp.name, 'r') as f:
                lines = f.readlines()
                generate_yaml(lines, dry_run=True)
            shutil.copyfile(tmp.name, CRONTAB_FILE)
            print("crontab updated.")
            sync_and_launch(attach=True)
        except Exception as e:
            print(f"Error: Invalid crontab syntax. Changes not saved.\n{e}")
    finally:
        os.unlink(tmp.name)

def generate_yaml(lines, dry_run=False):
    yaml_dict = {"session_name": SESSION_NAME, "windows": []}
    panes = []

    for i, line in enumerate(lines):
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        
        parts = line.split(maxsplit=5)
        if len(parts) < 6: continue
        
        schedule, command = " ".join(parts[:5]), parts[5]
        
        from croniter import croniter
        if not croniter.is_valid(schedule):
            raise ValueError(f"Invalid schedule on line {i+1}: {schedule}")

        run_cmd = f'"{RUNNER_PATH}" --run "{schedule}" "{command}"'

        if os.environ.get("TMUX_CRON_USE_WINDOWS") == "1":
            yaml_dict["windows"].append({"window_name": command.split(' ')[0][:20], "panes": [run_cmd]})
        else:
            panes.append(run_cmd)

    if not yaml_dict["windows"] and panes:
        yaml_dict["windows"].append({"window_name": "cron-jobs", "layout": "tiled", "panes": panes})

    if not dry_run:
        import yaml
        with open(YAML_FILE, "w") as f:
            yaml.dump(yaml_dict, f, default_flow_style=False)
            
    return yaml_dict

def sync_and_launch(attach=True):
    if not CRONTAB_FILE.exists():
        print("No crontab found. Use 'tmux-cron -e' to create one.")
        return

    is_stale = not YAML_FILE.exists() or CRONTAB_FILE.stat().st_mtime > YAML_FILE.stat().st_mtime
    
    if is_stale:
        print("Crontab changed. Regenerating config...")
        generate_yaml(CRONTAB_FILE.read_text().splitlines())
        sh('tmux kill-session -t "$SESSION"', env_vars={"SESSION": SESSION_NAME})
    
    # Launch if missing
    sh('tmux has-session -t "$SESSION" 2>/dev/null || uv run tmuxp load -d "$CONFIG"', 
       env_vars={"SESSION": SESSION_NAME, "CONFIG": str(YAML_FILE)})
    
    if attach:
        sh('tmux attach -t "$SESSION"', env_vars={"SESSION": SESSION_NAME})

def cron_runner(schedule, command):
    from croniter import croniter
    import time

    # $TMUX_PANE is provided by tmux; we just pass $TITLE via env
    sh('tmux set-option -p -t "$TMUX_PANE" automatic-rename off')
    sys.stdout.write(f"\033c\033]2;{command}\007")
    sys.stdout.flush()

    print(f"tmux-cron started: {schedule} {command}\n")

    iter = croniter(schedule, datetime.now())

    while True:
        next_run = iter.get_next(datetime)
        sleep_time = (next_run - datetime.now()).total_seconds()
        
        if sleep_time > 0:
            time.sleep(sleep_time)
        
        print(f"[{datetime.now().strftime('%Y-%m-%d %a %H:%M:%S')}] Executing...")
        sh('eval "$CMD"', env_vars={"CMD": command})

if __name__ == "__main__":
    args = sys.argv[1:]

    if not args:
        sync_and_launch(attach=True)
    elif args[0] in ["-e", "--edit"]:
        run_editor()
    elif args[0] in ["-l", "--list"]:
        if CRONTAB_FILE.exists():
            print(CRONTAB_FILE.read_text())
        else:
            print("Crontab is empty.")
    elif args[0] in ["-a", "--attach"]:
        sh('tmux attach -t "$SESSION"', env_vars={"SESSION": SESSION_NAME})
    elif args[0] in ["-h", "--help"]:
        print_help()
    elif args[0] == "--run" and len(args) == 3:
        cron_runner(args[1], args[2])
    else:
        print_help()